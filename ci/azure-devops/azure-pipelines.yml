trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main
      - feature/*

variables:
  CONTAINER_IMAGE: ''  # e.g., myregistry.azurecr.io/app
  IMAGE_DIGEST: ''     # e.g., sha256:abcd...
  SIGN_AND_VERIFY: 'true'  # signing/verification required for prod

stages:
- stage: Build
  displayName: "Build & Test"
  jobs:
  - job: BuildAndTest
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - checkout: self

    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.12'

    - script: |
        cd app
        mkdir -p ../artifacts/logs
        pip install -r requirements.txt 2>&1 | tee ../artifacts/logs/pip-install.log
        python -m compileall main.py 2>&1 | tee ../artifacts/logs/tests.log
      displayName: "Install deps & run basic tests"

    - task: PublishPipelineArtifact@1
      displayName: "Publish CI logs"
      inputs:
        targetPath: "$(System.DefaultWorkingDirectory)/artifacts/logs"
        artifactName: "ci-logs"

- stage: Deploy_Dev
  displayName: "Deploy to Dev (AWS)"
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - deployment: DeployToDev
    displayName: "Deploy to Dev"
    environment: "dev"
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self

          - script: |
              echo "Deploying to dev (placeholder)"
            displayName: "Deploy script"

- stage: Deploy_Prod
  displayName: "Deploy to Prod (Azure)"
  dependsOn: Deploy_Dev
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - deployment: DeployToProd
    displayName: "Deploy to Prod"
    environment: "prod"
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
          - script: |
              echo "Deploying to prod (placeholder)"
            displayName: "Deploy script"

          - script: |
              if [ "$(SIGN_AND_VERIFY)" != "true" ]; then
                echo "Signing and verification are mandatory for prod; set SIGN_AND_VERIFY=true."
                exit 1
              fi
              if [ -z "$(CONTAINER_IMAGE)" ] || [ -z "$(IMAGE_DIGEST)" ]; then
                echo "CONTAINER_IMAGE or IMAGE_DIGEST not set; cannot sign/verify."
                exit 1
              fi
              curl -sSL https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64 -o /usr/local/bin/cosign
              chmod +x /usr/local/bin/cosign
              COSIGN_EXPERIMENTAL=1 cosign sign --yes "$(CONTAINER_IMAGE)@$(IMAGE_DIGEST)"
              COSIGN_EXPERIMENTAL=1 cosign verify "$(CONTAINER_IMAGE)@$(IMAGE_DIGEST)"
            displayName: "Sign and verify image by digest (cosign)"
            condition: succeeded()
